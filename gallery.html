<!DOCTYPE html>
<html lang="ne">
<head>
    <meta charset="UTF-8">
    <title>Deepmani Font Fixed Editor</title>
    <style>
        /* दिपमनी फन्ट लोड गर्ने - फाइलको नाम Deepmani.ttf नै हुनुपर्छ */
        @font-face {
            font-family: 'Deepmani';
            src: url('Deepmani.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        body { font-family: 'Segoe UI', sans-serif; background: #eceff1; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); max-width: 950px; width: 100%; text-align: center; }
        
        .upload-section { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .box { border: 2px dashed #0984e3; padding: 10px; border-radius: 10px; background: #f0f7ff; }
        
        .controls { 
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; 
            background: #f1f2f6; padding: 15px; border-radius: 10px; text-align: left; 
        }
        .full { grid-column: span 4; }
        
        /* इनपुट बक्समा पनि दिपमनी फन्ट देखिने बनाइएको */
        #captionInput { 
            width: 100%; padding: 12px; border-radius: 5px; border: 2px solid #0984e3; 
            font-family: 'Deepmani', Arial, sans-serif; 
            font-size: 22px; box-sizing: border-box; 
        }

        label { font-size: 11px; font-weight: bold; text-transform: uppercase; color: #636e72; }
        input[type="range"], select, input[type="color"] { width: 100%; padding: 5px; cursor: pointer; }

        #canvas-wrapper { 
            position: relative; margin: 20px auto; background: #000;
            border: 5px solid black; width: fit-content; line-height: 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
        }
        canvas { width: 100%; height: auto; display: block; cursor: crosshair; }

        .btn-group { display: flex; gap: 10px; grid-column: span 4; }
        .btn { flex: 1; padding: 14px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-save { background: #00b894; color: white; }
        .btn-reset { background: #d63031; color: white; }
    </style>
</head>
<body>

<div class="card">
    <h2 style="font-family: 'Deepmani', sans-serif;">Deepmani Font Photo Editor</h2>
    
    <div class="upload-section">
        <div class="box">
            <label>फोटोहरू छान्नुहोस्:</label>
            <input type="file" id="photoPicker" accept="image/*" multiple onchange="loadImages()">
        </div>
        <div class="box">
            <label>लोगो थप्नुहोस् (PNG):</label>
            <input type="file" id="logoPicker" accept="image/*" onchange="loadLogo()">
        </div>
    </div>

    <div class="controls">
        <div class="full">
            <label>यहाँ टाइप गर्नुहोस् (यसले दिपमनीमा लेख्नेछ):</label>
            <input type="text" id="captionInput" placeholder="klkdf] k|of]u u/L n]Vg'xf];\ .." oninput="drawAll()">
        </div>
        
        <div>
            <label>अक्षर साइज: <span id="fSizeVal">45</span>px</label>
            <input type="range" id="fontSizeRange" min="10" max="150" value="45" oninput="drawAll()">
        </div>
        <div>
            <label>लोगो साइज: <span id="lSizeVal">100</span>px</label>
            <input type="range" id="logoSizeRange" min="30" max="300" value="100" oninput="drawAll()">
        </div>
        <div>
            <label>अक्षर रङ:</label>
            <input type="color" id="textColor" value="#ffffff" oninput="drawAll()">
        </div>
        <div>
            <label>ब्राइटनेस: <span id="bVal">120</span>%</label>
            <input type="range" id="brightRange" min="50" max="200" value="120" oninput="drawAll()">
        </div>

        <div class="btn-group">
            <button class="btn btn-save" onclick="downloadJPG()">डाउनलोड (JPG)</button>
            <button class="btn btn-reset" onclick="resetAll()">रिसेट</button>
        </div>
    </div>

    <div id="canvas-wrapper">
        <canvas id="mainCanvas"></canvas>
    </div>
</div>

<script>
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');
    const CW = 800, CH = 450;
    canvas.width = CW; canvas.height = CH;

    let imgObjects = [];
    let textObj = { text: "", x: 400, y: 380, isDragging: false };
    let logoObj = { img: null, x: 20, y: 20, w: 100, h: 100, isDragging: false };
    let isDraggingImg = false, selectedImgIdx = -1, startX, startY;

    // मल्टी-फङ्सन १: फन्ट लोड भए नभएको चेक गर्ने
    document.fonts.load("20px 'Deepmani'").then(function() {
        console.log("Deepmani Loaded");
        drawAll();
    });

    // मल्टी-फङ्सन २: फोटो लोड गर्ने
    async function loadImages() {
        const files = document.getElementById('photoPicker').files;
        if (!files.length) return;
        imgObjects = [];
        const count = Math.min(files.length, 4);
        for (let i = 0; i < count; i++) {
            const img = await new Promise(res => {
                const im = new Image(); im.onload = () => res(im);
                im.src = URL.createObjectURL(files[i]);
            });
            let cellW = CW, cellH = CH;
            if (count === 2) cellW = CW / 2;
            else if (count >= 3) { cellW = CW / 2; cellH = CH / 2; }
            const scale = Math.max(cellW / img.width, cellH / img.height);
            imgObjects.push({ img, x: 0, y: 0, scale, cellW, cellH });
        }
        drawAll();
    }

    // मल्टी-फङ्सन ३: लोगो लोड गर्ने
    function loadLogo() {
        const file = document.getElementById('logoPicker').files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => { logoObj.img = img; drawAll(); };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    // मल्टी-फङ्सन ४: मुख्य ड्रइङ
    function drawAll() {
        document.getElementById('bVal').innerText = document.getElementById('brightRange').value;
        document.getElementById('fSizeVal').innerText = document.getElementById('fontSizeRange').value;
        document.getElementById('lSizeVal').innerText = document.getElementById('logoSizeRange').value;
        
        ctx.clearRect(0, 0, CW, CH);
        ctx.filter = `brightness(${document.getElementById('brightRange').value}%)`;

        imgObjects.forEach((obj, i) => {
            let dx = 0, dy = 0;
            if (imgObjects.length === 2) dx = i * obj.cellW;
            else if (imgObjects.length >= 3) { dx = (i % 2) * obj.cellW; dy = Math.floor(i / 2) * obj.cellH; }
            ctx.save();
            ctx.beginPath(); ctx.rect(dx, dy, obj.cellW, obj.cellH); ctx.clip();
            ctx.drawImage(obj.img, dx + obj.x, dy + obj.y, obj.img.width * obj.scale, obj.img.height * obj.scale);
            ctx.restore();
        });

        ctx.filter = 'none';

        // लोगो साइज कन्ट्रोल
        if (logoObj.img) {
            const lSize = document.getElementById('logoSizeRange').value;
            const ratio = logoObj.img.width / logoObj.img.height;
            logoObj.w = lSize; logoObj.h = lSize / ratio;
            ctx.drawImage(logoObj.img, logoObj.x, logoObj.y, logoObj.w, logoObj.h);
        }

        // टेक्स्ट (दिपमनी फन्टमा)
        textObj.text = document.getElementById('captionInput').value;
        if (textObj.text) {
            const fSize = parseInt(document.getElementById('fontSizeRange').value);
            ctx.font = `${fSize}px 'Deepmani'`; // यहाँ Deepmani मात्र लेख्ने
            ctx.textAlign = "center";
            ctx.lineWidth = fSize/7;
            ctx.strokeStyle = "black";
            ctx.strokeText(textObj.text, textObj.x, textObj.y);
            ctx.fillStyle = document.getElementById('textColor').value;
            ctx.fillText(textObj.text, textObj.x, textObj.y);
        }
    }

    // ड्र्याग एण्ड ड्रप लजिक
    canvas.onmousedown = (e) => {
        const rect = canvas.getBoundingClientRect();
        const mx = (e.clientX - rect.left) * (CW / rect.width);
        const my = (e.clientY - rect.top) * (CH / rect.height);

        if (logoObj.img && mx > logoObj.x && mx < logoObj.x + logoObj.w && my > logoObj.y && my < logoObj.y + logoObj.h) {
            logoObj.isDragging = true;
        } else {
            const tWidth = ctx.measureText(textObj.text).width;
            const fSize = parseInt(document.getElementById('fontSizeRange').value);
            if (mx > textObj.x - tWidth/2 - 20 && mx < textObj.x + tWidth/2 + 20 && my > textObj.y - fSize && my < textObj.y + 20) {
                textObj.isDragging = true;
            } else {
                imgObjects.forEach((obj, i) => {
                    let dx = 0, dy = 0;
                    if (imgObjects.length === 2) dx = i * obj.cellW;
                    else if (imgObjects.length >= 3) { dx = (i % 2) * obj.cellW; dy = Math.floor(i / 2) * obj.cellH; }
                    if (mx >= dx && mx <= dx + obj.cellW && my >= dy && my <= dy + obj.cellH) selectedImgIdx = i;
                });
                isDraggingImg = true;
            }
        }
        startX = mx; startY = my;
    };

    window.onmousemove = (e) => {
        if (!logoObj.isDragging && !textObj.isDragging && (!isDraggingImg || selectedImgIdx === -1)) return;
        const rect = canvas.getBoundingClientRect();
        const mx = (e.clientX - rect.left) * (CW / rect.width);
        const my = (e.clientY - rect.top) * (CH / rect.height);
        const dx = mx - startX, dy = my - startY;

        if (logoObj.isDragging) { logoObj.x += dx; logoObj.y += dy; }
        else if (textObj.isDragging) { textObj.x += dx; textObj.y += dy; }
        else { imgObjects[selectedImgIdx].x += dx; imgObjects[selectedImgIdx].y += dy; }
        
        startX = mx; startY = my; drawAll();
    };

    window.onmouseup = () => { logoObj.isDragging = false; textObj.isDragging = false; isDraggingImg = false; selectedImgIdx = -1; };

    function resetAll() { location.reload(); }

    function downloadJPG() {
        let q = 0.9;
        const save = () => {
            canvas.toBlob(blob => {
                if (blob.size > 200 * 1024 && q > 0.2) { q -= 0.05; save(); }
                else {
                    const link = document.createElement('a');
                    link.download = `Photo_Deepmani_Edit.jpg`;
                    link.href = URL.createObjectURL(blob); link.click();
                }
            }, 'image/jpeg', q);
        };
        save();
    }
</script>

</body>
</html>
