<!DOCTYPE html>
<html lang="ne">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Education Nepal - Ultimate CMS</title>
    
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <style>
        :root { --primary: #e31e24; --secondary: #1a73e8; --sidebar: #202124; --hover: #3c4043; --bg: #f4f6f9; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; display: flex; background: var(--bg); }
        
        /* Sidebar */
        .sidebar { width: 260px; height: 100vh; background: var(--sidebar); color: #fff; position: fixed; left: 0; top: 0; z-index: 100; }
        .logo { padding: 25px; font-size: 20px; font-weight: bold; border-bottom: 1px solid var(--hover); text-align: center; color: var(--primary); }
        .nav-link { padding: 15px 25px; cursor: pointer; display: flex; align-items: center; transition: 0.2s; border-left: 4px solid transparent; gap: 10px; }
        .nav-link:hover, .nav-link.active { background: var(--hover); border-left-color: var(--primary); }

        .main { margin-left: 260px; width: calc(100% - 260px); padding: 40px; box-sizing: border-box; min-height: 100vh; }
        .card { background: #fff; border-radius: 12px; padding: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 25px; }
        .hidden { display: none !important; }

        input, select, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 15px; }
        #editor-container { height: 400px; background: #fff; margin-bottom: 20px; }
        
        /* Search Box */
        .search-container { margin-bottom: 20px; position: relative; }
        .search-input { padding-left: 40px; background: #fff; border: 2px solid #eee; }
        
        .btn-group { display: flex; gap: 12px; margin-top: 25px; }
        button { padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-pub { background: var(--primary); color: #fff; flex: 2; }
        .btn-draft { background: #5f6368; color: #fff; flex: 1; }
        .btn-backup { background: #28a745; color: white; margin-top: 20px; width: 100%; }

        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; padding: 15px; text-align: left; border-bottom: 2px solid #eee; }
        td { padding: 15px; border-bottom: 1px solid #eee; }
        .status-badge { padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .live { background: #e6f4ea; color: #1e8e3e; }
        .draft { background: #f1f3f4; color: #5f6368; }

        #auth-screen { position: fixed; inset: 0; background: #fff; z-index: 10000; display: flex; justify-content: center; align-items: center; flex-direction: column; text-align: center; }
    </style>
</head>
<body>

<div id="auth-screen">
    <h1 style="color: var(--primary); font-size: 32px;">Education Nepal CMS</h1>
    <p>Please login to manage your blog.</p>
    <button onclick="startGoogleAuth()" style="background: #4285F4; color: white; padding: 16px 40px; border-radius: 50px; cursor: pointer;">Google ‡§≤‡§ó‡§á‡§®</button>
</div>

<div class="sidebar">
    <div class="logo">ADMIN CMS</div>
    <div class="nav-link active" id="nav-editor" onclick="openTab('tab-editor')">‚úçÔ∏è ‡§®‡§Ø‡§æ‡§Å ‡§∏‡§Æ‡§æ‡§ö‡§æ‡§∞</div>
    <div class="nav-link" id="nav-posts" onclick="openTab('tab-posts'); fetchPostsList();">üìÑ ‡§∏‡§¨‡•à ‡§™‡•ã‡§∑‡•ç‡§ü‡§π‡§∞‡•Ç</div>
    <div class="nav-link" id="nav-stats" onclick="openTab('tab-stats'); fetchStats();">üìä ‡§§‡§•‡•ç‡§Ø‡§æ‡§ô‡•ç‡§ï ‡§∞ ‡§¨‡•ç‡§Ø‡§æ‡§ï‡§Ö‡§™</div>
</div>

<div class="main">
    <div id="tab-editor" class="tab-content card">
        <h2 id="form-heading">‡§®‡§Ø‡§æ‡§Å ‡§∏‡§Æ‡§æ‡§ö‡§æ‡§∞</h2>
        <input type="text" id="p-title" placeholder="‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï...">
        <input type="text" id="p-labels" placeholder="Labels (‡§ï‡§Æ‡§æ ‡§™‡•ç‡§∞‡§Ø‡•ã‡§ó ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç)">
        <textarea id="p-desc" rows="2" placeholder="Search Description (SEO)"></textarea>
        <div id="editor-container"></div>
        <div class="btn-group">
            <button class="btn-pub" id="save-btn" onclick="processPost('LIVE')">‡§™‡§¨‡•ç‡§≤‡§ø‡§∂ ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</button>
            <button class="btn-draft" id="draft-btn" onclick="processPost('DRAFT')">‡§°‡•ç‡§∞‡§æ‡§´‡•ç‡§ü</button>
        </div>
    </div>

    <div id="tab-posts" class="tab-content card hidden">
        <h2>‡§™‡•ã‡§∑‡•ç‡§ü ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§®</h2>
        <div class="search-container">
            <input type="text" id="postSearch" class="search-input" placeholder="üîç ‡§∏‡§Æ‡§æ‡§ö‡§æ‡§∞ ‡§ñ‡•ã‡§ú‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç..." onkeyup="filterPosts()">
        </div>
        <table id="postsTable">
            <thead><tr><th>‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï</th><th>‡§Ö‡§µ‡§∏‡•ç‡§•‡§æ</th><th>‡§ï‡§æ‡§∞‡•ç‡§Ø</th></tr></thead>
            <tbody id="posts-list-body"></tbody>
        </table>
    </div>

    <div id="tab-stats" class="tab-content card hidden">
        <h2>‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§∞ ‡§¨‡•ç‡§Ø‡§æ‡§ï‡§Ö‡§™</h2>
        <div id="stats-display" style="display: flex; gap: 20px; margin-bottom: 30px;"></div>
        <hr>
        <h3>‡§°‡§æ‡§ü‡§æ ‡§¨‡•ç‡§Ø‡§æ‡§ï‡§Ö‡§™ (Excel)</h3>
        <p>‡§§‡§™‡§æ‡§à‡§Ç‡§ï‡•ã ‡§∏‡§¨‡•à ‡§∏‡§Æ‡§æ‡§ö‡§æ‡§∞‡§π‡§∞‡•Ç‡§ï‡•ã ‡§∏‡•Ç‡§ö‡•Ä Excel (CSV) ‡§´‡§æ‡§á‡§≤‡§Æ‡§æ ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§</p>
        <button class="btn-backup" onclick="exportToExcel()">üì• ‡§∏‡§¨‡•à ‡§™‡•ã‡§∑‡•ç‡§ü ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç (Backup)</button>
    </div>
</div>

<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
    const CLIENT_ID = '749823606982-3o2tcrn6ne9ncni49l4nfskg5am25i60.apps.googleusercontent.com';
    const BLOG_ID = '4810240129416724295';
    let g_token = '';
    let editingPostId = null;

    const quill = new Quill('#editor-container', {
        theme: 'snow',
        modules: { toolbar: [[{'header': [1, 2, false]}], ['bold', 'italic', 'underline'], ['link', 'image', 'video'], [{'list': 'ordered'}, {'list': 'bullet'}]] }
    });

    function openTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        document.getElementById(tabId).classList.remove('hidden');
        document.getElementById('nav-' + tabId.split('-')[1]).classList.add('active');
    }

    function startGoogleAuth() {
        google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: 'https://www.googleapis.com/auth/blogger',
            callback: (res) => { g_token = res.access_token; document.getElementById('auth-screen').classList.add('hidden'); }
        }).requestAccessToken();
    }

    async function processPost(status) {
        const title = document.getElementById('p-title').value;
        const labels = document.getElementById('p-labels').value.split(',').map(l => l.trim());
        const content = quill.root.innerHTML;
        const snippet = document.getElementById('p-desc').value;

        const payload = { kind: "blogger#post", title, content, labels, customMetaData: snippet };
        let url = `https://www.googleapis.com/blogger/v3/blogs/${BLOG_ID}/posts/${editingPostId || ''}${status === 'DRAFT' ? '?isDraft=true' : ''}`;

        const res = await fetch(url, {
            method: editingPostId ? 'PUT' : 'POST',
            headers: { 'Authorization': `Bearer ${g_token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        if(res.ok) { alert("‡§∏‡§´‡§≤ ‡§≠‡§Ø‡•ã!"); location.reload(); }
    }

    async function fetchPostsList() {
        const res = await fetch(`https://www.googleapis.com/blogger/v3/blogs/${BLOG_ID}/posts?status=all&maxResults=100`, {
            headers: { 'Authorization': `Bearer ${g_token}` }
        });
        const data = await res.json();
        let rows = '';
        data.items.forEach(p => {
            rows += `<tr>
                <td class="post-title-cell">${p.title}</td>
                <td><span class="status-badge ${p.status === 'DRAFT' ? 'draft' : 'live'}">${p.status}</span></td>
                <td><button onclick="setupEdit('${p.id}')">Edit</button></td>
            </tr>`;
        });
        document.getElementById('posts-list-body').innerHTML = rows;
    }

    function filterPosts() {
        const input = document.getElementById('postSearch').value.toLowerCase();
        const rows = document.querySelectorAll('#posts-list-body tr');
        rows.forEach(row => {
            const title = row.querySelector('.post-title-cell').innerText.toLowerCase();
            row.style.display = title.includes(input) ? '' : 'none';
        });
    }

    async function setupEdit(id) {
        const res = await fetch(`https://www.googleapis.com/blogger/v3/blogs/${BLOG_ID}/posts/${id}`, {
            headers: { 'Authorization': `Bearer ${g_token}` }
        });
        const p = await res.json();
        editingPostId = id;
        document.getElementById('p-title').value = p.title;
        quill.root.innerHTML = p.content;
        openTab('tab-editor');
    }

    async function fetchStats() {
        const res = await fetch(`https://www.googleapis.com/blogger/v3/blogs/${BLOG_ID}`, {
            headers: { 'Authorization': `Bearer ${g_token}` }
        });
        const d = await res.json();
        document.getElementById('stats-display').innerHTML = `
            <div class="card" style="flex:1; text-align:center;"><h3>‡§ï‡•Å‡§≤ ‡§™‡•ã‡§∑‡•ç‡§ü</h3><h2>${d.posts.totalItems}</h2></div>
            <div class="card" style="flex:1; text-align:center;"><h3>‡§ï‡•Å‡§≤ ‡§™‡•á‡§ú</h3><h2>${d.pages.totalItems}</h2></div>`;
    }

    async function exportToExcel() {
        const res = await fetch(`https://www.googleapis.com/blogger/v3/blogs/${BLOG_ID}/posts?status=all&maxResults=500`, {
            headers: { 'Authorization': `Bearer ${g_token}` }
        });
        const data = await res.json();
        let csv = "Title,Date,Status,URL\n";
        data.items.forEach(p => {
            csv += `"${p.title.replace(/"/g, '""')}","${p.published}","${p.status}","${p.url}"\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.setAttribute('href', url);
        a.setAttribute('download', 'education_nepal_backup.csv');
        a.click();
    }
</script>
</body>
</html>
