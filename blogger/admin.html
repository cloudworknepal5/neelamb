<!DOCTYPE html>
<html lang="ne">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Education Nepal - Ultimate CMS</title>
    
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <style>
        :root { --primary: #e31e24; --secondary: #1a73e8; --sidebar: #202124; --hover: #3c4043; --bg: #f8f9fa; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; display: flex; background: var(--bg); color: #333; }
        
        /* Sidebar */
        .sidebar { width: 260px; height: 100vh; background: var(--sidebar); color: #fff; position: fixed; left: 0; top: 0; overflow-y: auto; }
        .logo { padding: 25px; font-size: 20px; font-weight: bold; border-bottom: 1px solid var(--hover); text-align: center; color: var(--primary); }
        .nav-link { padding: 15px 25px; cursor: pointer; display: flex; align-items: center; transition: 0.2s; border-left: 4px solid transparent; }
        .nav-link:hover, .nav-link.active { background: var(--hover); border-left-color: var(--primary); }

        /* Main Area */
        .main { margin-left: 260px; width: calc(100% - 260px); padding: 40px; box-sizing: border-box; }
        .card { background: #fff; border-radius: 8px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .hidden { display: none !important; }

        /* Form Controls */
        input, select { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #dadce0; border-radius: 5px; box-sizing: border-box; }
        #editor { height: 400px; background: #fff; margin-bottom: 20px; }
        
        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        button { padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; transition: 0.3s; }
        .btn-main { background: var(--primary); color: #fff; flex: 2; }
        .btn-sec { background: #5f6368; color: #fff; flex: 1; }
        .btn-main:hover { opacity: 0.9; }

        /* Post List Table */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #f1f3f4; padding: 15px; text-align: left; font-size: 14px; }
        td { padding: 15px; border-bottom: 1px solid #eee; font-size: 14px; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; text-transform: uppercase; font-weight: bold; }
        .badge-live { background: #e6f4ea; color: #1e8e3e; }
        .badge-draft { background: #f1f3f4; color: #5f6368; }
        .action-btns button { padding: 5px 10px; font-size: 12px; margin-right: 5px; }

        /* Login Overlay */
        #auth-overlay { position: fixed; inset: 0; background: #fff; z-index: 10000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body>

<div id="auth-overlay">
    <h1 style="color: var(--primary); margin-bottom: 10px;">Education Nepal CMS</h1>
    <p>‡§¨‡•ç‡§≤‡§ó ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§® ‡§ó‡§∞‡•ç‡§® ‡§Ü‡§´‡•ç‡§®‡•ã ‡§ó‡•Å‡§ó‡§≤ ‡§è‡§ï‡§æ‡§â‡§®‡•ç‡§ü ‡§≤‡§ó‡§á‡§® ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§</p>
    <button onclick="initAuth()" style="background: var(--secondary); color: #fff; padding: 15px 40px; font-size: 18px; border-radius: 30px; margin-top: 20px;">Google ‡§∏‡§Å‡§ó ‡§≤‡§ó‡§á‡§®</button>
</div>

<div class="sidebar">
    <div class="logo">ADMIN PANEL</div>
    <div class="nav-link active" id="link-editor" onclick="switchTab('tab-editor')">‚úçÔ∏è ‡§®‡§Ø‡§æ‡§Å ‡§™‡•ã‡§∑‡•ç‡§ü</div>
    <div class="nav-link" id="link-posts" onclick="switchTab('tab-posts'); fetchAllPosts();">üìÑ ‡§∏‡§¨‡•à ‡§™‡•ã‡§∑‡•ç‡§ü‡§π‡§∞‡•Ç</div>
    <div class="nav-link" id="link-stats" onclick="switchTab('tab-stats'); fetchBlogStats();">üìä ‡§§‡§•‡•ç‡§Ø‡§æ‡§ô‡•ç‡§ï (Stats)</div>
    <div class="nav-link" onclick="location.reload()">üîÑ ‡§∞‡§ø‡§´‡•ç‡§∞‡•á‡§∏</div>
</div>

<div class="main">
    
    <div id="tab-editor" class="tab-content card">
        <h2 id="editor-title">‡§®‡§Ø‡§æ‡§Å ‡§∏‡§Æ‡§æ‡§ö‡§æ‡§∞ ‡§≤‡•á‡§ñ‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</h2>
        <input type="text" id="post-title" placeholder="‡§∏‡§Æ‡§æ‡§ö‡§æ‡§∞‡§ï‡•ã ‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï ‡§Ø‡§π‡§æ‡§Å ‡§≤‡•á‡§ñ‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç...">
        <input type="text" id="post-labels" placeholder="Labels (‡§ú‡§∏‡•ç‡§§‡•à: ‡§∂‡§ø‡§ï‡•ç‡§∑‡§æ, ‡§ñ‡•á‡§≤‡§ï‡•Å‡§¶) - ‡§ï‡§Æ‡§æ (,) ‡§≤‡•á ‡§õ‡•Å‡§ü‡•ç‡§Ø‡§æ‡§â‡§®‡•Å‡§π‡•ã‡§∏‡•ç">
        
        <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 10px;">
            <label style="font-size: 14px;">Schedule (‡§ê‡§ö‡•ç‡§õ‡§ø‡§ï):</label>
            <input type="datetime-local" id="post-schedule" style="width: auto;">
        </div>

        <div id="editor"></div>

        <div class="btn-group">
            <button class="btn-main" id="btn-save" onclick="handlePostSubmit('LIVE')">‡§™‡§¨‡•ç‡§≤‡§ø‡§∂ ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</button>
            <button class="btn-sec" id="btn-draft" onclick="handlePostSubmit('DRAFT')">‡§°‡•ç‡§∞‡§æ‡§´‡•ç‡§ü‡§Æ‡§æ ‡§∏‡•á‡§≠ ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</button>
        </div>
    </div>

    <div id="tab-posts" class="tab-content card hidden">
        <h2>‡§∏‡§¨‡•à ‡§™‡•ã‡§∑‡•ç‡§ü‡§π‡§∞‡•Ç ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§® ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</h2>
        <table>
            <thead>
                <tr>
                    <th>‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï</th>
                    <th>‡§Ö‡§µ‡§∏‡•ç‡§•‡§æ</th>
                    <th>‡§Æ‡§ø‡§§‡§ø</th>
                    <th>‡§ï‡§æ‡§∞‡•ç‡§Ø</th>
                </tr>
            </thead>
            <tbody id="posts-table-body">
                <tr><td colspan="4">‡§≤‡•ã‡§° ‡§π‡•Å‡§Å‡§¶‡•à‡§õ...</td></tr>
            </tbody>
        </table>
    </div>

    <div id="tab-stats" class="tab-content card hidden">
        <h2>‡§¨‡•ç‡§≤‡§ó‡§ï‡•ã ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü</h2>
        <div id="stats-view" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
            </div>
    </div>

</div>

<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
    const CLIENT_ID = '749823606982-3o2tcrn6ne9ncni49l4nfskg5am25i60.apps.googleusercontent.com';
    const BLOG_ID = '4810240129416724295';
    let accessToken = '';
    let currentEditId = null;

    // Quill Editor with Image Optimization
    const quill = new Quill('#editor', {
        theme: 'snow',
        modules: {
            toolbar: {
                container: [
                    [{'header': [1, 2, 3, false]}],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{'color': []}, {'background': []}],
                    ['link', 'image', 'video'],
                    [{'list': 'ordered'}, {'list': 'bullet'}],
                    ['clean']
                ],
                handlers: { image: imageOptimizerHandler }
            }
        }
    });

    // Image Optimizer Logic
    function imageOptimizerHandler() {
        const input = document.createElement('input');
        input.setAttribute('type', 'file');
        input.setAttribute('accept', 'image/*');
        input.click();
        input.onchange = async () => {
            const file = input.files[0];
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const maxWidth = 800;
                    const scale = maxWidth / img.width;
                    canvas.width = maxWidth;
                    canvas.height = img.height * scale;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    const optimizedUrl = canvas.toDataURL('image/jpeg', 0.7);
                    const range = quill.getSelection();
                    quill.insertEmbed(range.index, 'image', optimizedUrl);
                };
            };
        };
    }

    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        document.getElementById(tabId).classList.remove('hidden');
        document.getElementById('link-' + tabId.split('-')[1]).classList.add('active');
    }

    function initAuth() {
        const client = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: 'https://www.googleapis.com/auth/blogger',
            callback: (res) => {
                accessToken = res.access_token;
                document.getElementById('auth-overlay').classList.add('hidden');
            }
        });
        client.requestAccessToken();
    }

    // Create or Update Post
    async function handlePostSubmit(status) {
        const title = document.getElementById('post-title').value;
        const labels = document.getElementById('post-labels').value.split(',').map(l => l.trim());
        const content = quill.root.innerHTML;
        const schedule = document.getElementById('post-schedule').value;

        if(!title || quill.getText().trim().length < 2) return alert("‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï ‡§∞ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§≤‡•á‡§ñ‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§");

        const body = { kind: "blogger#post", title, content, labels };
        if(schedule) body.published = new Date(schedule).toISOString();

        let url = `https://www.googleapis.com/blogger/v3/blogs/${BLOG_ID}/posts/`;
        let method = 'POST';

        if(currentEditId) {
            url += currentEditId;
            method = 'PUT';
        } else if(status === 'DRAFT') {
            url += '?isDraft=true';
        }

        const res = await fetch(url, {
            method: method,
            headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });

        if(res.ok) {
            alert(currentEditId ? "‡§Ö‡§™‡§°‡•á‡§ü ‡§∏‡§´‡§≤!" : "‡§™‡§¨‡•ç‡§≤‡§ø‡§∂ ‡§∏‡§´‡§≤!");
            location.reload();
        } else {
            alert("‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§≠‡§Ø‡•ã‡•§ ‡§´‡•á‡§∞‡§ø ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§");
        }
    }

    async function fetchAllPosts() {
        const container = document.getElementById('posts-table-body');
        container.innerHTML = '<tr><td colspan="4">‡§≤‡•ã‡§° ‡§π‡•Å‡§Å‡§¶‡•à‡§õ...</td></tr>';
        
        const res = await fetch(`https://www.googleapis.com/blogger/v3/blogs/${BLOG_ID}/posts?status=all&maxResults=50`, {
            headers: { 'Authorization': `Bearer ${accessToken}` }
        });
        const data = await res.json();
        
        let html = '';
        if(data.items) {
            data.items.forEach(p => {
                html += `
                <tr>
                    <td>${p.title}</td>
                    <td><span class="badge ${p.status === 'DRAFT' ? 'badge-draft' : 'badge-live'}">${p.status}</span></td>
                    <td>${new Date(p.published).toLocaleDateString()}</td>
                    <td class="action-btns">
                        <button onclick="loadPostToEdit('${p.id}')" style="background:#4285F4; color:#fff;">Edit</button>
                        <button onclick="deletePost('${p.id}')" style="background:var(--primary); color:#fff;">Delete</button>
                    </td>
                </tr>`;
            });
        }
        container.innerHTML = html || '<tr><td colspan="4">‡§ï‡•Å‡§®‡•à ‡§™‡•ã‡§∑‡•ç‡§ü ‡§≠‡•á‡§ü‡§ø‡§è‡§®‡•§</td></tr>';
    }

    async function loadPostToEdit(id) {
        const res = await fetch(`https://www.googleapis.com/blogger/v3/blogs/${BLOG_ID}/posts/${id}`, {
            headers: { 'Authorization': `Bearer ${accessToken}` }
        });
        const p = await res.json();
        
        currentEditId = id;
        document.getElementById('post-title').value = p.title;
        document.getElementById('post-labels').value = p.labels ? p.labels.join(', ') : '';
        quill.root.innerHTML = p.content;
        document.getElementById('editor-title').innerText = "‡§∏‡§Æ‡§æ‡§ö‡§æ‡§∞ ‡§∏‡§Æ‡•ç‡§™‡§æ‡§¶‡§® ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç";
        document.getElementById('btn-save').innerText = "‡§Ö‡§™‡§°‡•á‡§ü ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç";
        document.getElementById('btn-draft').classList.add('hidden');
        switchTab('tab-editor');
    }

    async function deletePost(id) {
        if(!confirm("‡§ï‡•á ‡§§‡§™‡§æ‡§à‡§Ç ‡§Ø‡•ã ‡§∏‡§Æ‡§æ‡§ö‡§æ‡§∞ ‡§°‡§ø‡§≤‡§ø‡§ü ‡§ó‡§∞‡•ç‡§® ‡§ö‡§æ‡§π‡§®‡•Å‡§π‡•Å‡§®‡•ç‡§õ?")) return;
        const res = await fetch(`https://www.googleapis.com/blogger/v3/blogs/${BLOG_ID}/posts/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${accessToken}` }
        });
        if(res.ok) fetchAllPosts();
    }

    async function fetchBlogStats() {
        const res = await fetch(`https://www.googleapis.com/blogger/v3/blogs/${BLOG_ID}`, {
            headers: { 'Authorization': `Bearer ${accessToken}` }
        });
        const d = await res.json();
        document.getElementById('stats-view').innerHTML = `
            <div class="card" style="text-align:center;"><h3>‡§ï‡•Å‡§≤ ‡§™‡•ã‡§∑‡•ç‡§ü</h3><h1>${d.posts.totalItems}</h1></div>
            <div class="card" style="text-align:center;"><h3>‡§ï‡•Å‡§≤ ‡§™‡•á‡§ú</h3><h1>${d.pages.totalItems}</h1></div>
        `;
    }
</script>
</body>
</html>
