<!DOCTYPE html>
<html lang="ne">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Education Nepal - Optimized CMS</title>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        :root { --primary: #e31e24; --secondary: #1a73e8; --sidebar: #202124; --text: #3c4043; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; background: #f8f9fa; }
        
        .sidebar { width: 260px; height: 100vh; background: var(--sidebar); color: #fff; position: fixed; }
        .logo { padding: 25px; font-size: 22px; font-weight: bold; border-bottom: 1px solid #3c4043; color: var(--primary); }
        .nav-link { padding: 15px 25px; cursor: pointer; display: flex; align-items: center; transition: 0.2s; }
        .nav-link:hover, .nav-link.active { background: #3c4043; border-left: 4px solid var(--primary); }

        .main { margin-left: 260px; width: 100%; padding: 40px; }
        .card { background: #fff; border-radius: 8px; padding: 30px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .hidden { display: none; }

        input, select { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #dadce0; border-radius: 4px; box-sizing: border-box; }
        #editor { height: 350px; margin: 20px 0; }
        
        .action-bar { display: flex; gap: 10px; margin-top: 20px; }
        button { padding: 12px 25px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; }
        .btn-pub { background: var(--primary); color: #fff; flex: 2; }
        .btn-draft { background: #5f6368; color: #fff; flex: 1; }
        
        table { width: 100%; border-collapse: collapse; }
        th { background: #f1f3f4; padding: 12px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; }
        .live { background: #e6f4ea; color: #1e8e3e; }
        .draft { background: #f1f3f4; color: #5f6368; }

        #overlay { position: fixed; inset: 0; background: #fff; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body>

<div id="overlay">
    <h1 style="color: var(--primary);">Education Nepal CMS</h1>
    <button onclick="handleAuth()" style="padding:15px 40px; background:var(--secondary); color:#fff; border:none; border-radius:30px; font-size:18px; cursor:pointer;">‡§ó‡•Ç‡§ó‡§≤‡§¨‡§æ‡§ü ‡§∏‡•Å‡§∞‡•Å ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</button>
</div>

<div class="sidebar">
    <div class="logo">Education Nepal</div>
    <div class="nav-link active" onclick="switchTab('tab-editor')">‚úçÔ∏è ‡§®‡§Ø‡§æ‡§Å ‡§™‡•ã‡§∑‡•ç‡§ü</div>
    <div class="nav-link" onclick="switchTab('tab-posts'); fetchPosts();">üìÑ ‡§∏‡§¨‡•à ‡§™‡•ã‡§∑‡•ç‡§ü‡§π‡§∞‡•Ç</div>
    <div class="nav-link" onclick="switchTab('tab-stats'); fetchStats();">üìä ‡§∏‡•ç‡§ü‡§æ‡§ü</div>
</div>

<div class="main">
    <div id="tab-editor" class="tab card">
        <h2>‡§®‡§Ø‡§æ‡§Å ‡§∏‡§Æ‡§æ‡§ö‡§æ‡§∞ (Optimized)</h2>
        <input type="text" id="post-title" placeholder="‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï...">
        <input type="text" id="post-labels" placeholder="Labels (‡§ï‡§Æ‡§æ‡§≤‡•á ‡§õ‡•Å‡§ü‡•ç‡§Ø‡§æ‡§â‡§®‡•Å‡§π‡•ã‡§∏‡•ç)...">
        
        <div id="editor"></div>
        
        <div class="action-bar">
            <button class="btn-pub" onclick="savePost('LIVE')">‡§™‡§¨‡•ç‡§≤‡§ø‡§∂ ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</button>
            <button class="btn-draft" onclick="savePost('DRAFT')">‡§°‡•ç‡§∞‡§æ‡§´‡•ç‡§ü‡§Æ‡§æ ‡§∞‡§æ‡§ñ‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</button>
        </div>
    </div>

    <div id="tab-posts" class="tab card hidden">
        <h2>‡§∏‡§¨‡•à ‡§™‡•ã‡§∑‡•ç‡§ü‡§π‡§∞‡•Ç</h2>
        <table>
            <thead><tr><th>‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï</th><th>‡§Ö‡§µ‡§∏‡•ç‡§•‡§æ</th><th>‡§ï‡§æ‡§∞‡•ç‡§Ø</th></tr></thead>
            <tbody id="list-container"></tbody>
        </table>
    </div>

    <div id="tab-stats" class="tab card hidden">
        <h2>‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü</h2>
        <div id="stats-content">‡§≤‡•ã‡§° ‡§π‡•Å‡§Å‡§¶‡•à‡§õ...</div>
    </div>
</div>

<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
    const CLIENT_ID = '749823606982-3o2tcrn6ne9ncni49l4nfskg5am25i60.apps.googleusercontent.com';
    const BLOG_ID = '4810240129416724295';
    let token = '';

    const quill = new Quill('#editor', {
        theme: 'snow',
        modules: {
            toolbar: {
                container: [[{'header': [1, 2, false]}], ['bold', 'italic', 'underline'], ['link', 'image', 'video']],
                handlers: { image: imageHandler }
            }
        }
    });

    // ‡•ß. ‡§á‡§Æ‡•á‡§ú ‡§Ö‡§™‡•ç‡§ü‡§ø‡§Æ‡§æ‡§á‡§ú ‡§ó‡§∞‡•ç‡§®‡•á ‡§´‡§ô‡•ç‡§∏‡§®
    function imageHandler() {
        const input = document.createElement('input');
        input.setAttribute('type', 'file');
        input.setAttribute('accept', 'image/*');
        input.click();

        input.onchange = async () => {
            const file = input.files[0];
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // ‡§Ö‡§ß‡§ø‡§ï‡§§‡§Æ ‡•Æ‡•¶‡•¶ ‡§™‡§ø‡§ï‡•ç‡§∏‡•á‡§≤ ‡§ö‡•å‡§°‡§æ‡§á‡§Æ‡§æ ‡§ñ‡•Å‡§Æ‡•ç‡§ö‡•ç‡§Ø‡§æ‡§â‡§®‡•á
                    const maxWidth = 800;
                    const scale = maxWidth / img.width;
                    canvas.width = maxWidth;
                    canvas.height = img.height * scale;

                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    // ‡•≠‡•¶% ‡§ï‡•ç‡§µ‡§æ‡§≤‡§ø‡§ü‡•Ä‡§Æ‡§æ ‡§ï‡•ã‡§Æ‡•ç‡§™‡•ç‡§∞‡•á‡§∏ ‡§ó‡§∞‡•ç‡§®‡•á
                    const optimizedDataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    
                    const range = quill.getSelection();
                    quill.insertEmbed(range.index, 'image', optimizedDataUrl);
                };
            };
        };
    }

    function switchTab(id) {
        document.querySelectorAll('.tab').forEach(t => t.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    function handleAuth() {
        google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: 'https://www.googleapis.com/auth/blogger',
            callback: (res) => { token = res.access_token; document.getElementById('overlay').style.display = 'none'; }
        }).requestAccessToken();
    }

    async function savePost(status) {
        const body = {
            title: document.getElementById('post-title').value,
            content: quill.root.innerHTML,
            labels: document.getElementById('post-labels').value.split(',')
        };
        const url = `https://www.googleapis.com/blogger/v3/blogs/${BLOG_ID}/posts/${status === 'DRAFT' ? '?isDraft=true' : ''}`;
        const res = await fetch(url, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        if(res.ok) alert("‡§∏‡§´‡§≤ ‡§≠‡§Ø‡•ã!");
    }

    async function fetchPosts() {
        const res = await fetch(`https://www.googleapis.com/blogger/v3/blogs/${BLOG_ID}/posts?status=all`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        let html = '';
        data.items.forEach(p => {
            html += `<tr><td>${p.title}</td><td><span class="status-badge ${p.status === 'DRAFT' ? 'draft' : 'live'}">${p.status}</span></td><td><button onclick="deletePost('${p.id}')">üóëÔ∏è</button></td></tr>`;
        });
        document.getElementById('list-container').innerHTML = html;
    }

    async function fetchStats() {
        const res = await fetch(`https://www.googleapis.com/blogger/v3/blogs/${BLOG_ID}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const d = await res.json();
        document.getElementById('stats-content').innerHTML = `‡§ï‡•Å‡§≤ ‡§™‡•ã‡§∑‡•ç‡§ü: ${d.posts.totalItems} | ‡§ï‡•Å‡§≤ ‡§™‡•á‡§ú: ${d.pages.totalItems}`;
    }
</script>
</body>
</html>
