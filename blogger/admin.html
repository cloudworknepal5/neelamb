<!DOCTYPE html>
<html lang="ne">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Education Nepal - Ultimate CMS v2</title>
    
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <style>
        :root { --primary: #e31e24; --secondary: #1a73e8; --sidebar: #202124; --hover: #3c4043; --bg: #f4f6f9; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; display: flex; background: var(--bg); color: #333; }
        
        /* Sidebar Navigation */
        .sidebar { width: 260px; height: 100vh; background: var(--sidebar); color: #fff; position: fixed; left: 0; top: 0; z-index: 100; }
        .logo { padding: 25px; font-size: 20px; font-weight: bold; border-bottom: 1px solid var(--hover); text-align: center; color: var(--primary); }
        .nav-link { padding: 15px 25px; cursor: pointer; display: flex; align-items: center; transition: 0.2s; border-left: 4px solid transparent; gap: 10px; }
        .nav-link:hover, .nav-link.active { background: var(--hover); border-left-color: var(--primary); }

        /* Main Content */
        .main { margin-left: 260px; width: calc(100% - 260px); padding: 40px; box-sizing: border-box; min-height: 100vh; }
        .card { background: #fff; border-radius: 12px; padding: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 25px; }
        .hidden { display: none !important; }

        /* Form Styling */
        input, select { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 15px; }
        #editor-container { height: 450px; background: #fff; margin-bottom: 20px; border-radius: 0 0 6px 6px; }
        .ql-toolbar { border-radius: 6px 6px 0 0; }
        
        .btn-group { display: flex; gap: 12px; margin-top: 25px; }
        button { padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 15px; transition: all 0.2s; }
        .btn-pub { background: var(--primary); color: #fff; flex: 2; }
        .btn-draft { background: #5f6368; color: #fff; flex: 1; }
        .btn-pub:hover { background: #c2181d; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { background: #f8f9fa; padding: 15px; text-align: left; font-weight: 600; border-bottom: 2px solid #eee; }
        td { padding: 15px; border-bottom: 1px solid #eee; }
        .status-badge { padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .live { background: #e6f4ea; color: #1e8e3e; }
        .draft { background: #f1f3f4; color: #5f6368; }
        .action-btn { background: #eee; padding: 6px 12px; margin-right: 5px; font-size: 13px; color: #333; }
        .action-btn.del { color: var(--primary); border: 1px solid #ffcccb; }

        /* Login Screen */
        #auth-screen { position: fixed; inset: 0; background: #fff; z-index: 10000; display: flex; justify-content: center; align-items: center; flex-direction: column; text-align: center; }
    </style>
</head>
<body>

<div id="auth-screen">
    <div style="max-width: 400px; padding: 20px;">
        <h1 style="color: var(--primary); font-size: 32px; margin-bottom: 10px;">Education Nepal</h1>
        <p style="color: #666; margin-bottom: 30px;">‡§Ü‡§´‡•ç‡§®‡•ã ‡§¨‡•ç‡§≤‡§ó ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§® ‡§ó‡§∞‡•ç‡§® ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§§‡§∞‡§ø‡§ï‡§æ‡§≤‡•á ‡§≤‡§ó‡§á‡§® ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§</p>
        <button onclick="startGoogleAuth()" style="background: #4285F4; color: white; padding: 16px 40px; border-radius: 50px; font-size: 18px; box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3);">Google ‡§∏‡§Å‡§ó ‡§≤‡§ó‡§á‡§® ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</button>
    </div>
</div>

<div class="sidebar">
    <div class="logo">ADMIN CMS</div>
    <div class="nav-link active" id="nav-editor" onclick="openTab('tab-editor')">‚úçÔ∏è ‡§®‡§Ø‡§æ‡§Å ‡§∏‡§Æ‡§æ‡§ö‡§æ‡§∞</div>
    <div class="nav-link" id="nav-posts" onclick="openTab('tab-posts'); fetchPostsList();">üìÑ ‡§∏‡§¨‡•à ‡§™‡•ã‡§∑‡•ç‡§ü‡§π‡§∞‡•Ç</div>
    <div class="nav-link" id="nav-stats" onclick="openTab('tab-stats'); fetchStats();">üìä ‡§§‡§•‡•ç‡§Ø‡§æ‡§ô‡•ç‡§ï (Stats)</div>
    <div class="nav-link" onclick="location.reload()">üîÑ ‡§∞‡§ø‡§´‡•ç‡§∞‡•á‡§∏</div>
</div>

<div class="main">
    
    <div id="tab-editor" class="tab-content card">
        <h2 id="form-heading">‡§®‡§Ø‡§æ‡§Å ‡§∏‡§Æ‡§æ‡§ö‡§æ‡§∞ ‡§≤‡•á‡§ñ‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</h2>
        <input type="text" id="p-title" placeholder="‡§Ø‡§π‡§æ‡§Å ‡§∏‡§Æ‡§æ‡§ö‡§æ‡§∞‡§ï‡•ã ‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï ‡§≤‡•á‡§ñ‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç...">
        <input type="text" id="p-labels" placeholder="Labels (‡§ú‡§∏‡•ç‡§§‡•à: ‡§∂‡§ø‡§ï‡•ç‡§∑‡§æ, ‡§≤‡•ã‡§ï‡§∏‡•á‡§µ‡§æ) - ‡§Ö‡§≤‡•ç‡§™‡§µ‡§ø‡§∞‡§æ‡§Æ (,) ‡§™‡•ç‡§∞‡§Ø‡•ã‡§ó ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç">
        
        <div style="display: flex; gap: 20px; align-items: center; background: #f9f9f9; padding: 10px; border-radius: 6px;">
            <label style="font-size: 14px; font-weight: bold;">‡§∏‡§Æ‡§Ø ‡§Æ‡§ø‡§≤‡§æ‡§â‡§®‡•á (Scheduling):</label>
            <input type="datetime-local" id="p-schedule" style="width: auto; margin: 0;">
        </div>

        <div id="editor-container"></div>

        <div class="btn-group">
            <button class="btn-pub" id="save-btn" onclick="processPost('LIVE')">‡§™‡§¨‡•ç‡§≤‡§ø‡§∂ ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</button>
            <button class="btn-draft" id="draft-btn" onclick="processPost('DRAFT')">‡§°‡•ç‡§∞‡§æ‡§´‡•ç‡§ü‡§Æ‡§æ ‡§∞‡§æ‡§ñ‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</button>
        </div>
    </div>

    <div id="tab-posts" class="tab-content card hidden">
        <h2>‡§™‡•ã‡§∑‡•ç‡§ü ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§®</h2>
        <table>
            <thead>
                <tr>
                    <th>‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï</th>
                    <th>‡§Ö‡§µ‡§∏‡•ç‡§•‡§æ</th>
                    <th>‡§Æ‡§ø‡§§‡§ø</th>
                    <th>‡§ï‡§æ‡§∞‡•ç‡§Ø</th>
                </tr>
            </thead>
            <tbody id="posts-list-body">
                <tr><td colspan="4">‡§≤‡•ã‡§° ‡§π‡•Å‡§Å‡§¶‡•à‡§õ...</td></tr>
            </tbody>
        </table>
    </div>

    <div id="tab-stats" class="tab-content card hidden">
        <h2>‡§¨‡•ç‡§≤‡§ó ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü</h2>
        <div id="stats-display" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
            </div>
    </div>

</div>

<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
    const CLIENT_ID = '749823606982-3o2tcrn6ne9ncni49l4nfskg5am25i60.apps.googleusercontent.com';
    const BLOG_ID = '4810240129416724295';
    let g_token = '';
    let editingPostId = null;

    // Rich Text Editor with Image Compression
    const quill = new Quill('#editor-container', {
        theme: 'snow',
        modules: {
            toolbar: {
                container: [
                    [{'header': [1, 2, 3, false]}],
                    ['bold', 'italic', 'underline'],
                    [{'color': []}, {'background': []}],
                    ['link', 'image', 'video'],
                    [{'list': 'ordered'}, {'list': 'bullet'}],
                    ['clean']
                ],
                handlers: { image: optimizedImageHandler }
            }
        }
    });

    // Image Optimization Logic (Resize to 800px & 70% Quality)
    function optimizedImageHandler() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.click();
        input.onchange = async () => {
            const file = input.files[0];
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const scale = 800 / img.width;
                    canvas.width = 800;
                    canvas.height = img.height * scale;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    const compressedData = canvas.toDataURL('image/jpeg', 0.7);
                    const range = quill.getSelection();
                    quill.insertEmbed(range.index, 'image', compressedData);
                };
            };
        };
    }

    function openTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        document.getElementById(tabId).classList.remove('hidden');
        document.getElementById('nav-' + tabId.split('-')[1]).classList.add('active');
    }

    function startGoogleAuth() {
        const client = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: 'https://www.googleapis.com/auth/blogger',
            callback: (res) => {
                if(res.access_token) {
                    g_token = res.access_token;
                    document.getElementById('auth-screen').classList.add('hidden');
                }
            }
        });
        client.requestAccessToken();
    }

    // Save/Update Post Logic
    async function processPost(status) {
        const title = document.getElementById('p-title').value;
        const labels = document.getElementById('p-labels').value.split(',').map(l => l.trim());
        const content = quill.root.innerHTML;
        const schedule = document.getElementById('p-schedule').value;

        if(!title) return alert("‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï ‡§≤‡•á‡§ñ‡•ç‡§® ‡§®‡§≠‡•Å‡§≤‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç!");

        const payload = { kind: "blogger#post", title, content, labels };
        if(schedule) payload.published = new Date(schedule).toISOString();

        let endpoint = `https://www.googleapis.com/blogger/v3/blogs/${BLOG_ID}/posts/`;
        let verb = 'POST';

        if(editingPostId) {
            endpoint += editingPostId;
            verb = 'PUT';
        } else if(status === 'DRAFT') {
            endpoint += '?isDraft=true';
        }

        const res = await fetch(endpoint, {
            method: verb,
            headers: { 'Authorization': `Bearer ${g_token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if(res.ok) {
            alert("‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§∏‡§´‡§≤ ‡§≠‡§Ø‡•ã!");
            location.reload();
        } else {
            const err = await res.json();
            alert("Error: " + err.error.message);
        }
    }

    // Fetch All Posts (Live + Draft)
    async function fetchPostsList() {
        const body = document.getElementById('posts-list-body');
        body.innerHTML = '<tr><td colspan="4">‡§™‡•ã‡§∑‡•ç‡§ü‡§π‡§∞‡•Ç ‡§≤‡•ã‡§° ‡§π‡•Å‡§Å‡§¶‡•à‡§õ‡§®‡•ç...</td></tr>';
        
        try {
            const res = await fetch(`https://www.googleapis.com/blogger/v3/blogs/${BLOG_ID}/posts?status=all&maxResults=50`, {
                headers: { 'Authorization': `Bearer ${g_token}` }
            });
            const data = await res.json();
            
            let rows = '';
            if(data.items && data.items.length > 0) {
                data.items.forEach(p => {
                    rows += `
                    <tr>
                        <td><strong>${p.title}</strong></td>
                        <td><span class="status-badge ${p.status === 'DRAFT' ? 'draft' : 'live'}">${p.status}</span></td>
                        <td>${new Date(p.published).toLocaleDateString()}</td>
                        <td>
                            <button class="action-btn" onclick="setupEditMode('${p.id}')">Edit</button>
                            <button class="action-btn del" onclick="confirmDelete('${p.id}')">Delete</button>
                        </td>
                    </tr>`;
                });
                body.innerHTML = rows;
            } else {
                body.innerHTML = '<tr><td colspan="4">‡§ï‡•Å‡§®‡•à ‡§™‡•ã‡§∑‡•ç‡§ü ‡§≠‡•á‡§ü‡§ø‡§è‡§®‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§≤‡§ó‡§á‡§® ‡§ó‡§∞‡•ç‡§¶‡§æ ‡§∏‡§¨‡•à ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§¶‡§ø‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§</td></tr>';
            }
        } catch (e) {
            body.innerHTML = '<tr><td colspan="4" style="color:red;">API Error: ‡§°‡•á‡§ü‡§æ ‡§§‡§æ‡§®‡•ç‡§® ‡§∏‡§ï‡§ø‡§è‡§®‡•§</td></tr>';
        }
    }

    async function setupEditMode(id) {
        const res = await fetch(`https://www.googleapis.com/blogger/v3/blogs/${BLOG_ID}/posts/${id}`, {
            headers: { 'Authorization': `Bearer ${g_token}` }
        });
        const p = await res.json();
        
        editingPostId = id;
        document.getElementById('p-title').value = p.title;
        document.getElementById('p-labels').value = p.labels ? p.labels.join(', ') : '';
        quill.root.innerHTML = p.content;
        document.getElementById('form-heading').innerText = "‡§∏‡§Æ‡§æ‡§ö‡§æ‡§∞ ‡§∏‡§Æ‡•ç‡§™‡§æ‡§¶‡§® ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç";
        document.getElementById('save-btn').innerText = "‡§Ö‡§™‡§°‡•á‡§ü ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç";
        document.getElementById('draft-btn').classList.add('hidden');
        openTab('tab-editor');
        window.scrollTo(0,0);
    }

    async function confirmDelete(id) {
        if(confirm("‡§ï‡•á ‡§§‡§™‡§æ‡§à‡§Ç ‡§Ø‡•ã ‡§∏‡§Æ‡§æ‡§ö‡§æ‡§∞ ‡§∏‡§ß‡•à‡§Å‡§ï‡§æ ‡§≤‡§æ‡§ó‡§ø ‡§π‡§ü‡§æ‡§â‡§® ‡§ö‡§æ‡§π‡§®‡•Å‡§π‡•Å‡§®‡•ç‡§õ?")) {
            const res = await fetch(`https://www.googleapis.com/blogger/v3/blogs/${BLOG_ID}/posts/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${g_token}` }
            });
            if(res.ok) fetchPostsList();
        }
    }

    async function fetchStats() {
        const res = await fetch(`https://www.googleapis.com/blogger/v3/blogs/${BLOG_ID}`, {
            headers: { 'Authorization': `Bearer ${g_token}` }
        });
        const d = await res.json();
        document.getElementById('stats-display').innerHTML = `
            <div class="card" style="text-align:center;"><h3>‡§ï‡•Å‡§≤ ‡§™‡•ã‡§∑‡•ç‡§ü‡§π‡§∞‡•Ç</h3><h1 style="color:var(--primary); font-size:48px;">${d.posts.totalItems}</h1></div>
            <div class="card" style="text-align:center;"><h3>‡§ï‡•Å‡§≤ ‡§™‡•á‡§ú‡§π‡§∞‡•Ç</h3><h1 style="color:var(--secondary); font-size:48px;">${d.pages.totalItems}</h1></div>
        `;
    }
</script>
</body>
</html>
