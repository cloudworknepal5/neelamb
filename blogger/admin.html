<!DOCTYPE html>
<html lang="ne">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Education Nepal - Professional CMS</title>
    
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <style>
        :root { --primary: #e31e24; --secondary: #1a73e8; --sidebar: #202124; --hover: #3c4043; --bg: #f4f6f9; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; display: flex; background: var(--bg); color: #333; }
        
        /* Sidebar */
        .sidebar { width: 260px; height: 100vh; background: var(--sidebar); color: #fff; position: fixed; left: 0; top: 0; z-index: 100; }
        .logo { padding: 25px; font-size: 20px; font-weight: bold; border-bottom: 1px solid var(--hover); text-align: center; color: var(--primary); letter-spacing: 1px; }
        .nav-link { padding: 15px 25px; cursor: pointer; display: flex; align-items: center; transition: 0.2s; border-left: 4px solid transparent; gap: 12px; }
        .nav-link:hover, .nav-link.active { background: var(--hover); border-left-color: var(--primary); }

        /* Main Area */
        .main { margin-left: 260px; width: calc(100% - 260px); padding: 40px; box-sizing: border-box; min-height: 100vh; }
        .card { background: #fff; border-radius: 12px; padding: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 25px; }
        .hidden { display: none !important; }

        /* Form Controls */
        input, select, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 15px; }
        #editor-container { height: 420px; background: #fff; margin-bottom: 20px; border-radius: 0 0 6px 6px; }
        
        .search-container { margin-bottom: 20px; position: relative; }
        .search-input { padding: 12px 12px 12px 40px; background: #fff; border: 2px solid #eee; }
        
        .btn-group { display: flex; gap: 12px; margin-top: 25px; }
        button { padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 15px; transition: 0.3s; }
        .btn-pub { background: var(--primary); color: #fff; flex: 2; }
        .btn-draft { background: #5f6368; color: #fff; flex: 1; }
        .btn-backup { background: #28a745; color: white; width: 100%; margin-top: 15px; font-size: 16px; }
        .btn-backup:hover { background: #218838; }

        /* Table Style */
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; padding: 15px; text-align: left; border-bottom: 2px solid #eee; color: #555; }
        td { padding: 15px; border-bottom: 1px solid #eee; }
        .badge { padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .badge-live { background: #e6f4ea; color: #1e8e3e; }
        .badge-draft { background: #f1f3f4; color: #5f6368; }

        #auth-screen { position: fixed; inset: 0; background: #fff; z-index: 10000; display: flex; justify-content: center; align-items: center; flex-direction: column; text-align: center; }
    </style>
</head>
<body>

<div id="auth-screen">
    <h1 style="color: var(--primary); font-size: 36px; margin-bottom: 5px;">Education Nepal</h1>
    <p style="color: #666; margin-bottom: 30px;">Professional Blogger CMS Dashboard</p>
    <button onclick="startGoogleAuth()" style="background: #4285F4; color: white; padding: 16px 45px; border-radius: 50px; cursor: pointer; font-size: 18px; border: none; box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3);">Google ‡§∏‡§Å‡§ó ‡§≤‡§ó‡§á‡§® ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</button>
</div>

<div class="sidebar">
    <div class="logo">ADMIN PANEL</div>
    <div class="nav-link active" id="nav-editor" onclick="openTab('tab-editor')">‚úçÔ∏è ‡§®‡§Ø‡§æ‡§Å ‡§∏‡§Æ‡§æ‡§ö‡§æ‡§∞</div>
    <div class="nav-link" id="nav-posts" onclick="openTab('tab-posts'); fetchPostsList();">üìÑ ‡§∏‡§¨‡•à ‡§™‡•ã‡§∑‡•ç‡§ü‡§π‡§∞‡•Ç</div>
    <div class="nav-link" id="nav-stats" onclick="openTab('tab-stats'); fetchStats();">üìä ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§∞ ‡§¨‡•ç‡§Ø‡§æ‡§ï‡§Ö‡§™</div>
    <div class="nav-link" onclick="location.reload()">üîÑ ‡§∞‡§ø‡§´‡•ç‡§∞‡•á‡§∏</div>
</div>

<div class="main">
    <div id="tab-editor" class="tab-content card">
        <h2 id="form-title">‡§®‡§Ø‡§æ‡§Å ‡§∏‡§Æ‡§æ‡§ö‡§æ‡§∞ ‡§∏‡§ø‡§∞‡•ç‡§ú‡§®‡§æ ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</h2>
        <input type="text" id="p-title" placeholder="‡§∏‡§Æ‡§æ‡§ö‡§æ‡§∞‡§ï‡•ã ‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï...">
        <input type="text" id="p-labels" placeholder="Labels (‡§ï‡§Æ‡§æ ‡§™‡•ç‡§∞‡§Ø‡•ã‡§ó ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç: ‡§∏‡§Æ‡§æ‡§ö‡§æ‡§∞, ‡§∂‡§ø‡§ï‡•ç‡§∑‡§æ, ‡§ñ‡•á‡§≤‡§ï‡•Å‡§¶)">
        <textarea id="p-desc" rows="2" placeholder="Search Description (SEO ‡§ï‡•ã ‡§≤‡§æ‡§ó‡§ø ‡§õ‡•ã‡§ü‡•ã ‡§µ‡§ø‡§µ‡§∞‡§£)"></textarea>
        
        <div id="editor-container"></div>

        <div class="btn-group">
            <button class="btn-pub" id="save-btn" onclick="processPost('LIVE')">‡§™‡§¨‡•ç‡§≤‡§ø‡§∂ ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</button>
            <button class="btn-draft" id="draft-btn" onclick="processPost('DRAFT')">‡§°‡•ç‡§∞‡§æ‡§´‡•ç‡§ü‡§Æ‡§æ ‡§∞‡§æ‡§ñ‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</button>
        </div>
    </div>

    <div id="tab-posts" class="tab-content card hidden">
        <h2>‡§∏‡§¨‡•à ‡§∏‡§Æ‡§æ‡§ö‡§æ‡§∞‡§π‡§∞‡•Ç</h2>
        <div class="search-container">
            <span style="position:absolute; left:15px; top:12px;">üîç</span>
            <input type="text" id="postSearch" class="search-input" placeholder="‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï‡§¨‡§æ‡§ü ‡§∏‡§Æ‡§æ‡§ö‡§æ‡§∞ ‡§ñ‡•ã‡§ú‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç..." onkeyup="filterPosts()">
        </div>
        <table>
            <thead><tr><th>‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï</th><th>‡§Ö‡§µ‡§∏‡•ç‡§•‡§æ</th><th>‡§ï‡§æ‡§∞‡•ç‡§Ø</th></tr></thead>
            <tbody id="posts-list-body"></tbody>
        </table>
    </div>

    <div id="tab-stats" class="tab-content card hidden">
        <h2>‡§¨‡•ç‡§≤‡§ó‡§ï‡•ã ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§∞ ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§¨‡•ç‡§Ø‡§æ‡§ï‡§Ö‡§™</h2>
        <div id="stats-display" style="display: flex; gap: 20px; margin-bottom: 30px;"></div>
        <hr style="border: 0; border-top: 1px solid #eee;">
        <div style="margin-top: 20px;">
            <h3>üì• ‡§ï‡§®‡•ç‡§ü‡•á‡§®‡•ç‡§ü ‡§¨‡•ç‡§Ø‡§æ‡§ï‡§Ö‡§™ (Excel/CSV)</h3>
            <p style="color: #666;">‡§Ü‡§´‡•ç‡§®‡•ã ‡§¨‡•ç‡§≤‡§ó‡§ï‡§æ ‡§∏‡§¨‡•à ‡§∏‡§Æ‡§æ‡§ö‡§æ‡§∞‡§π‡§∞‡•Ç ‡§è‡§â‡§ü‡§æ ‡§´‡§æ‡§á‡§≤‡§Æ‡§æ ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§∞‡§æ‡§ñ‡•ç‡§® ‡§§‡§≤‡§ï‡•ã ‡§¨‡§ü‡§® ‡§•‡§ø‡§ö‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§</p>
            <button class="btn-backup" onclick="exportToExcel()">Excel ‡§´‡§æ‡§á‡§≤ ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</button>
        </div>
    </div>
</div>

<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
    const CLIENT_ID = '749823606982-3o2tcrn6ne9ncni49l4nfskg5am25i60.apps.googleusercontent.com';
    const BLOG_ID = '4810240129416724295';
    let g_token = '';
    let editingId = null;

    const quill = new Quill('#editor-container', {
        theme: 'snow',
        modules: {
            toolbar: {
                container: [[{'header': [1, 2, 3, false]}], ['bold', 'italic', 'underline'], ['link', 'image', 'video'], [{'list': 'ordered'}, {'list': 'bullet'}], ['clean']],
                handlers: { image: imageOptimizer }
            }
        }
    });

    function imageOptimizer() {
        const input = document.createElement('input');
        input.type = 'file'; input.accept = 'image/*';
        input.click();
        input.onchange = () => {
            const file = input.files[0];
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const maxWidth = 800;
                    const scale = maxWidth / img.width;
                    canvas.width = maxWidth;
                    canvas.height = img.height * scale;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    const optimized = canvas.toDataURL('image/jpeg', 0.7);
                    const range = quill.getSelection();
                    quill.insertEmbed(range.index, 'image', optimized);
                };
            };
        };
    }

    function openTab(id) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        document.getElementById(id).classList.remove('hidden');
        document.getElementById('nav-' + id.split('-')[1]).classList.add('active');
    }

    function startGoogleAuth() {
        google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: 'https://www.googleapis.com/auth/blogger',
            callback: (res) => {
                if(res.access_token) {
                    g_token = res.access_token;
                    document.getElementById('auth-screen').classList.add('hidden');
                }
            }
        }).requestAccessToken();
    }

    async function processPost(status) {
        const title = document.getElementById('p-title').value;
        if(!title) return alert("‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï ‡§≤‡•á‡§ñ‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç!");
        
        const payload = {
            kind: "blogger#post",
            title: title,
            content: quill.root.innerHTML,
            labels: document.getElementById('p-labels').value.split(',').map(l => l.trim()),
            customMetaData: document.getElementById('p-desc').value
        };

        let url = `https://www.googleapis.com/blogger/v3/blogs/${BLOG_ID}/posts/`;
        if(editingId) url += editingId;
        else if(status === 'DRAFT') url += '?isDraft=true';

        const res = await fetch(url, {
            method: editingId ? 'PUT' : 'POST',
            headers: { 'Authorization': `Bearer ${g_token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if(res.ok) { alert("‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§∏‡§´‡§≤!"); location.reload(); }
    }

    async function fetchPostsList() {
        const body = document.getElementById('posts-list-body');
        body.innerHTML = '<tr><td colspan="3">‡§≤‡•ã‡§° ‡§π‡•Å‡§Å‡§¶‡•à‡§õ...</td></tr>';
        const res = await fetch(`https://www.googleapis.com/blogger/v3/blogs/${BLOG_ID}/posts?status=all&maxResults=100`, {
            headers: { 'Authorization': `Bearer ${g_token}` }
        });
        const data = await res.json();
        let html = '';
        if(data.items) {
            data.items.forEach(p => {
                html += `<tr>
                    <td class="t-cell"><strong>${p.title}</strong></td>
                    <td><span class="badge ${p.status === 'DRAFT' ? 'badge-draft' : 'badge-live'}">${p.status}</span></td>
                    <td><button onclick="editPost('${p.id}')" style="background:#eee; padding:5px 10px; border-radius:4px;">Edit</button></td>
                </tr>`;
            });
        }
        body.innerHTML = html || '<tr><td colspan="3">‡§™‡•ã‡§∑‡•ç‡§ü ‡§≠‡•á‡§ü‡§ø‡§è‡§®‡•§</td></tr>';
    }

    function filterPosts() {
        const val = document.getElementById('postSearch').value.toLowerCase();
        document.querySelectorAll('#posts-list-body tr').forEach(row => {
            row.style.display = row.querySelector('.t-cell').innerText.toLowerCase().includes(val) ? '' : 'none';
        });
    }

    async function editPost(id) {
        const res = await fetch(`https://www.googleapis.com/blogger/v3/blogs/${BLOG_ID}/posts/${id}`, {
            headers: { 'Authorization': `Bearer ${g_token}` }
        });
        const p = await res.json();
        editingId = id;
        document.getElementById('p-title').value = p.title;
        document.getElementById('p-labels').value = p.labels ? p.labels.join(', ') : '';
        quill.root.innerHTML = p.content;
        document.getElementById('form-title').innerText = "‡§∏‡§Æ‡§æ‡§ö‡§æ‡§∞ ‡§∏‡§Æ‡•ç‡§™‡§æ‡§¶‡§® ‡§Æ‡•ã‡§°";
        document.getElementById('save-btn').innerText = "‡§Ö‡§™‡§°‡•á‡§ü ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç";
        openTab('tab-editor');
    }

    async function fetchStats() {
        const res = await fetch(`https://www.googleapis.com/blogger/v3/blogs/${BLOG_ID}`, {
            headers: { 'Authorization': `Bearer ${g_token}` }
        });
        const d = await res.json();
        document.getElementById('stats-display').innerHTML = `
            <div class="card" style="flex:1; text-align:center;"><h3>‡§ï‡•Å‡§≤ ‡§™‡•ã‡§∑‡•ç‡§ü</h3><h2 style="color:var(--primary); font-size:32px;">${d.posts.totalItems}</h2></div>
            <div class="card" style="flex:1; text-align:center;"><h3>‡§ï‡•Å‡§≤ ‡§™‡•á‡§ú</h3><h2 style="color:var(--secondary); font-size:32px;">${d.pages.totalItems}</h2></div>
        `;
    }

    async function exportToExcel() {
        try {
            const res = await fetch(`https://www.googleapis.com/blogger/v3/blogs/${BLOG_ID}/posts?status=all&maxResults=500`, {
                headers: { 'Authorization': `Bearer ${g_token}` }
            });
            const data = await res.json();
            let csv = "Title,Date,Status,URL\n";
            data.items.forEach(p => {
                csv += `"${p.title.replace(/"/g, '""')}","${p.published}","${p.status}","${p.url}"\n`;
            });
            const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'Education_Nepal_Backup.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        } catch(e) { alert("‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø!"); }
    }
</script>
</body>
</html>
